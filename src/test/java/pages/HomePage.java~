package pages;

import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.interactions.Actions;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import java.time.Duration;

public class HomePage {

    WebDriver driver;

    // Constructor
    public HomePage(WebDriver driver) {
        this.driver = driver;
    }

    // Locators
    private By logo = By.id("nav-logo-sprites");
    private By searchBox = By.id("twotabsearchtextbox");
    private By promoBanner = By.id("desktop-banner"); // Bu ID değişebilir zamanla
    private By footer = By.id("navFooter");

    private By captchaBox = By.id("captchacharacters");  // Captcha'nın görünürlüğü kontrol edilen element (ID'yi güncelleyin)

    // Dil menüsü locater'ları
    private By languageMenu = By.id("icp-nav-flyout");

    // Actions / Methods
    public boolean isCaptchaPage() {
        try {
            WebElement captcha = driver.findElement(captchaBox);
            return captcha.isDisplayed(); // Eğer Captcha varsa true döner
        } catch (Exception e) {
            return false; // Eğer Captcha yoksa false döner
        }
    }

    // Elementlerin görünür olduğunu kontrol etme (WebDriverWait eklenmiş)
    public boolean isElementVisible(By locator) {
        try {
            WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(10));
            WebElement element = wait.until(ExpectedConditions.visibilityOfElementLocated(locator));
            return element.isDisplayed();
        } catch (Exception e) {
            return false;
        }
    }

    // Arama önerilerinin görünür olduğunu kontrol et
    public boolean isSearchSuggestionVisible() {
        try {
            WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(10));
            WebElement suggestion = wait.until(ExpectedConditions.visibilityOfElementLocated(
                    By.cssSelector("#nav-flyout-searchAjax .s-suggestion")));
            return suggestion.isDisplayed();
        } catch (Exception e) {
            return false;
        }
    }

    // Sayfa öğelerinin görünürlük kontrolü
    public boolean isLogoVisible() {
        return isElementVisible(logo);
    }

    public boolean isSearchBoxVisible() {
        return isElementVisible(searchBox);
    }

    public boolean isPromoBannerVisible() {
        return isElementVisible(promoBanner);
    }

    public boolean isFooterVisible() {
        return isElementVisible(footer);
    }

    public boolean enterSearchText(String searchQuery) {
        try {
            // Sayfanın tamamen yüklenmesini bekle
            WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(10));
            wait.until(ExpectedConditions.elementToBeClickable(By.id("twotabsearchtextbox")));  // Arama kutusunun tıklanabilir olmasını bekle

            // Arama kutusunu bul ve metni gir
            WebElement searchBox = driver.findElement(By.id("twotabsearchtextbox"));
            searchBox.sendKeys(searchQuery);

            return true;  // Başarıyla metin girildi
        } catch (Exception e) {
            System.out.println("Arama kutusuna metin girerken bir hata oluştu: " + e.getMessage());
            return false;  // Hata oluştuysa false döndür
        }
    }

    // Dil değiştirme işlemi
    public void changeLanguageToSpanish() {
        try {
            WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(15));

            // 1. Language menüsüne hover yap
            WebElement languageMenuElement = wait.until(ExpectedConditions.visibilityOfElementLocated(languageMenu));
            Actions actions = new Actions(driver);
            actions.moveToElement(languageMenuElement).pause(Duration.ofSeconds(1)).perform(); // Menüye hover

            // 2. İspanyolca dil seçeneğine tıklama
            WebElement espanolOptionElement = wait.until(ExpectedConditions.elementToBeClickable(By.cssSelector("a[lang='es-US']"))); // "es-US" dil seçeneği

            // JavaScript ile tıklama
            JavascriptExecutor js = (JavascriptExecutor) driver;
            js.executeScript("arguments[0].click();", espanolOptionElement); // JavaScript ile tıklama

            // Sayfanın yüklenmesini bekleyin
            WebDriverWait waitForUrlChange = new WebDriverWait(driver, Duration.ofSeconds(10));
            waitForUrlChange.until(ExpectedConditions.urlContains("language=es_US")); // URL'deki dil parametresi

            // Sayfa URL'sini yazdırarak kontrol edin
            String currentUrl = driver.getCurrentUrl();
            System.out.println("Mevcut URL: " + currentUrl);

            // URL'yi doğrulama
            if (!currentUrl.contains("language=es_US")) {
                throw new RuntimeException("Dil değişikliği yapılmadı. URL: " + currentUrl);
            }

        } catch (Exception e) {
            throw new RuntimeException("Dil değiştirilemedi: " + e.getMessage());
        }
    }

    // Sayfanın İspanyolca olduğunu doğrulama
    public boolean isPageInSpanish() {
        try {
            WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(20));
            wait.until(ExpectedConditions.visibilityOfElementLocated(By.tagName("body")));

            // Body metnini al ve küçük harfe çevir
            String bodyText = driver.findElement(By.tagName("body")).getText().toLowerCase();

            // İspanyolca olabilecek ifadelerle kontrol et
            return  bodyText.contains("todo") ||
                    bodyText.contains("ofertas del día") ||
                    bodyText.contains("listas") ||
                    bodyText.contains("prime video") ||
                    bodyText.contains("tarjetas de regalo") ||
                    bodyText.contains("servicio al cliente") ||
                    bodyText.contains("vender");

        } catch (Exception e) {
            System.out.println("İspanyolca kontrolü sırasında hata oluştu: " + e.getMessage());
            return false;
        }
    }

    //Giriş panelinin açıldığını doğrula
    public boolean clickSignInAndVerifyPanel() {
        try {
            WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(15));  // Bekleme süresi

            // Giriş butonuna tıklamadan önce öğenin tıklanabilir olduğundan emin olun
            WebElement signInButton = wait.until(ExpectedConditions.elementToBeClickable(By.id("nav-link-accountList")));
            signInButton.click();  // Tıklama işlemi

            // Email alanının görünür olup olmadığını kontrol et
            WebElement emailField = wait.until(ExpectedConditions.visibilityOfElementLocated(By.id("ap_email")));  // Email alanı görünüyor mu?
            return emailField.isDisplayed();  // Eğer email alanı görünüyorsa true döndür
        } catch (Exception e) {
            System.out.println("Hata: " + e.getMessage());
            return false;  // Eğer tıklama veya öğe kontrolü başarısız olursa false döndür
        }
    }

    //Lokasyon ayarı değiştirilince ürün içeriklerinin güncellendiğini doğrula
    public boolean changeZipCode(String zipCode) {
        try {
            WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(15));

            // "Deliver to" linkine tıkla
            WebElement deliverTo = wait.until(ExpectedConditions.elementToBeClickable(By.id("nav-global-location-popover-link")));
            deliverTo.click();

            // Posta kodu alanına zip gir
            WebElement postalCodeField = wait.until(ExpectedConditions.visibilityOfElementLocated(By.id("GLUXZipUpdateInput")));
            postalCodeField.clear();
            postalCodeField.sendKeys(zipCode);

            // Apply butonuna tıkla
            WebElement applyButton = driver.findElement(By.cssSelector("#GLUXZipUpdate .a-button-input"));
            applyButton.click();

            // Done butonu çıkarsa tıkla (bazı senaryolarda çıkmaz)
            try {
                WebElement doneButton = wait.until(ExpectedConditions.elementToBeClickable(By.name("glowDoneButton")));
                doneButton.click();
            } catch (Exception ignored) {
                System.out.println("Done butonu görünmedi, atlanıyor.");
            }

            // Lokasyon bilgisini bekle
            WebElement locationLine2 = wait.until(ExpectedConditions.visibilityOfElementLocated(By.id("glow-ingress-line2")));
            String locationText = locationLine2.getText().toLowerCase();

            // Alternatif olarak line1 + line2 birlikte kontrol edilebilir
            WebElement locationLine1 = driver.findElement(By.id("glow-ingress-line1"));
            String combinedLocation = (locationLine1.getText() + " " + locationLine2.getText()).toLowerCase();

            System.out.println("Güncellenmiş Lokasyon: " + combinedLocation);

            return combinedLocation.contains("new york") || combinedLocation.contains(zipCode);

        } catch (Exception e) {
            System.out.println("Lokasyon değiştirilemedi: " + e.getMessage());
            return false;
        }
    }

}
